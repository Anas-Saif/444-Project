<!DOCTYPE html>
<html lang="en" class="h-full bg-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Tasks - Student Pilot</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #ffffff;
        }

        .container {
            margin: 0 auto;
            max-width: 1000px;
            padding: 20px;
        }

        .custom-button {
            background-color: #0062FF;
            color: white;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .custom-button:hover {
            background-color: #0051d1;
        }

        .task-card {
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            display: inline-block;
            width: 23%; /* Ensure 4 tasks fit in a row */
            margin: 1%;
            text-align: center;
            cursor: pointer;
        }

        .task-gray {
            background-color: #f5f5f5; /* Default gray background for tasks without labels */
        }

        #taskModal, #labelModal, #infoModal {
            display: none;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .name-display {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .task-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        #logoutBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff4b4b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with user name and logout button -->
        <div id="header">
            <div>
                <span class="name-display" id="userName">Welcome, User</span>
            </div>
            <div>
                <button id="createTaskBtn" class="custom-button">Create Task</button>
                <button id="createLabelBtn" class="custom-button">Create Label</button>
            </div>
        </div>
        <button id="logoutBtn" class="custom-button">Log Out</button>

        <div id="taskList" class="task-grid">
            <!-- Tasks will be dynamically rendered here -->
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Create Task</h2>
            <input type="text" id="taskTitle" placeholder="Task Title" required />
            <textarea id="taskDescription" placeholder="Task Description"></textarea>
            <input type="date" id="taskDueDate" required />
            <select id="taskLabel">
                <option value="">No Label</option>
                <!-- Labels will be dynamically rendered here -->
            </select>
            <select id="taskPriority">
                <option value="Low">Low Priority</option>
                <option value="Medium">Medium Priority</option>
                <option value="High">High Priority</option>
            </select>
            <button id="saveTaskBtn" class="custom-button">Save Task</button>
        </div>
    </div>

    <!-- Label Modal -->
    <div id="labelModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Create Label</h2>
            <input type="text" id="labelName" placeholder="Label Name" required />
            <select id="labelColor" required>
                <option value="#FF5733">Red</option>
                <option value="#33FF57">Green</option>
                <option value="#3357FF">Blue</option>
                <option value="#FFC300">Yellow</option>
                <option value="#DAF7A6">Light Green</option>
                <option value="#C70039">Dark Red</option>
                <option value="#581845">Purple</option>
            </select>
            <button id="saveLabelBtn" class="custom-button">Save Label</button>
        </div>
    </div>

    <!-- Task Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <h3 id="taskInfoTitle"></h3>
            <p id="taskInfoDue"></p>
            <p id="taskInfoPriority"></p>
            <button id="updateTaskBtn" class="custom-button">Update Task</button>
            <button id="deleteTaskBtn" class="custom-button" style="background-color: #ff4b4b;">Delete Task</button>
            <button id="markCompleteBtn" class="custom-button">Mark as Completed</button>
            <button id="closeInfoModal" class="custom-button">Close</button>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8000'; 
        const token = localStorage.getItem('token');

        // Ensure that the user cannot access main.html without a token
        window.onload = () => {
            if (!token) {
                window.location.href = 'login.html'; // Redirect to login if no token is found
            } else {
                fetchUser();
                fetchLabels();
                fetchTasks();
            }
        };

        // Fetch and display user info
        async function fetchUser() {
            const response = await fetch(`${BASE_URL}/user/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const user = await response.json();
            document.getElementById('userName').textContent = `Welcome, ${user.first_name} ${user.last_name}`;
        }

        // Fetch and display labels in the task modal
        async function fetchLabels() {
            const response = await fetch(`${BASE_URL}/labels/`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const labels = await response.json();
            const labelSelect = document.getElementById('taskLabel');
            labelSelect.innerHTML = '<option value="">No Label</option>'; // Reset options

            labels.forEach(label => {
                const option = document.createElement('option');
                option.value = label.label_id;
                option.textContent = label.name;
                labelSelect.appendChild(option);
            });
        }

        // Fetch tasks and display them in the task list
        async function fetchTasks() {
            const response = await fetch(`${BASE_URL}/tasks/`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const tasks = await response.json();
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = ''; // Clear existing tasks

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = `task-card ${task.labels.length ? '' : 'task-gray'}`;
                taskCard.style.backgroundColor = task.labels.length ? task.labels[0].color : '#f5f5f5'; // Set label color

                taskCard.innerHTML = `
                    <h3 class="font-bold">${task.title}</h3>
                    <p>${task.description || 'No description'}</p>
                    <p>Due in: ${getDaysRemaining(task.due_date)} days</p>
                `;

                taskCard.addEventListener('click', () => showTaskInfo(task)); // Show task info modal

                taskList.appendChild(taskCard);
            });
        }

        // Calculate remaining days until due date
        function getDaysRemaining(dueDate) {
            const dueDateObj = new Date(dueDate);
            const today = new Date();
            const differenceInTime = dueDateObj - today;
            const differenceInDays = Math.ceil(differenceInTime / (1000 * 3600 * 24));
            return differenceInDays;
        }

        // Show task info modal
        function showTaskInfo(task) {
            document.getElementById('taskInfoTitle').textContent = `Task: ${task.title}`;
            document.getElementById('taskInfoDue').textContent = `Due: ${task.due_date}`;
            document.getElementById('taskInfoPriority').textContent = `Priority: ${task.priority || 'Not set'}`;
            
            document.getElementById('infoModal').style.display = 'flex';

            document.getElementById('deleteTaskBtn').onclick = () => deleteTask(task.task_id);
            document.getElementById('updateTaskBtn').onclick = () => updateTask(task);
        }

        // Delete task
        async function deleteTask(taskId) {
            if (confirm("Are you sure you want to delete this task?")) {
                await fetch(`${BASE_URL}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                alert('Task successfully deleted!');
                document.getElementById('infoModal').style.display = 'none'; // Close modal
                fetchTasks(); // Refresh tasks
            }
        }

        // Update task - opens the task modal pre-filled with task info
        function updateTask(task) {
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskDueDate').value = task.due_date;
            document.getElementById('taskPriority').value = task.priority || 'Low';
            document.getElementById('taskModal').style.display = 'flex'; // Open modal for update

            // Save the update
            document.getElementById('saveTaskBtn').onclick = async function () {
                const updatedTaskData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    due_date: document.getElementById('taskDueDate').value,
                    priority: document.getElementById('taskPriority').value
                };

                await fetch(`${BASE_URL}/tasks/${task.task_id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedTaskData)
                });

                document.getElementById('taskModal').style.display = 'none'; // Hide modal
                fetchTasks(); // Refresh task list
            };
        }

        // Save new task
        document.getElementById('saveTaskBtn')?.addEventListener('click', async () => {
            const taskTitle = document.getElementById('taskTitle').value;
            const taskDueDate = document.getElementById('taskDueDate').value;

            if (!taskTitle || !taskDueDate) {
                alert('Please fill in the required fields: Task Title and Due Date.');
                return;
            }

            const taskData = {
                title: taskTitle,
                description: document.getElementById('taskDescription').value,
                due_date: taskDueDate,
                labels: [document.getElementById('taskLabel').value], // List of label IDs
                priority: document.getElementById('taskPriority').value
            };

            await fetch(`${BASE_URL}/tasks/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            });

            document.getElementById('taskModal').style.display = 'none'; // Hide modal
            fetchTasks(); // Refresh task list
        });

        // Save new label
        document.getElementById('saveLabelBtn')?.addEventListener('click', async () => {
            const labelName = document.getElementById('labelName').value;
            const labelColor = document.getElementById('labelColor').value;

            if (!labelName || !labelColor) {
                alert('Please fill in the required fields: Label Name and Color.');
                return;
            }

            const labelData = {
                name: labelName,
                color: labelColor
            };

            await fetch(`${BASE_URL}/labels/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(labelData)
            });

            document.getElementById('labelModal').style.display = 'none'; // Hide modal
            fetchLabels(); // Refresh label list in task modal
        });

        // Show Task Modal
        document.getElementById('createTaskBtn')?.addEventListener('click', () => {
            document.getElementById('taskModal').style.display = 'flex';
        });

        // Show Label Modal
        document.getElementById('createLabelBtn')?.addEventListener('click', () => {
            document.getElementById('labelModal').style.display = 'flex';
        });

        // Close Modal (when clicking outside)
        window.addEventListener('click', function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        document.getElementById('closeInfoModal').addEventListener('click', () => {
            document.getElementById('infoModal').style.display = 'none'; // Close task info modal
        });
    </script>
</body>
</html>
